<!DOCTYPE html>
<html>
    <head>
        <style>
            #scatter_area {
                width:85%;
                aspect-ratio:9/5;
            }
            svg .dot text {
                /*font: 8px sans;*/
            }
            .slider-width{
                width: 90% !important; /* needed */
            }
            h2 {
                 text-align: center;
            }
            h2 span {
               font: 14px sans; 
            }
            #maxyear{

            }
        </style>
        <script src="https://d3js.org/d3.v7.js"></script>
    </head>
    <body>
        <h2>Moore's law <span><a href="https://en.wikipedia.org/wiki/Transistor_count">Transistor count</a></h2>
        <!-- Add an svg area, empty -->
        <div id="scatter_area"></div>
        <input class="slider-width" id="recent" type="range" width="750px">
        <div id="maxyear">1970</div>
    </body>
    <script src="mo.js"></script>
    <script>
    // loose based on https://www.d3-graph-gallery.com/graph/scatter_basic.html
        function setup(w,h){
            // set the dimensions and margins of the graph
            console.log(w)
            console.log(h)
             margin = {top: 10, right: 30, bottom: 45, left: 60}
             width = w - margin.left - margin.right
             height = h - margin.top - margin.bottom;

            // append the svg object to the body of the page
             svg = d3.select("#scatter_area")
               .append("svg")
               //.attr("viewbox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
               //.attr('preserveAspectRatio','xMidYMid meet')
                 .attr("width",w)
                 .attr("height",h)
               .append("g")
               .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            //Read the data
             data = processor;
            data.forEach(x=>{
                x.year = x.date * 1
                x.mos = x.mos * 1
            })

            //  let minmax = a=> a.reduce( (ac,x)=> [Math.min(ac[0],x),Math.max(ac[1],x)],[Number.POSITIVE_INFINITY,0])
            //  let years = minmax(data.map(x=>x.year))
            //  let moses =minmax(data.map(x=>x.mos))
             extentx = d3.extent(data.map(x=>x.year))
             extenty = d3.extent(data.map(x=>x.mos))

            // Add X axis
             x = d3.scaleLinear().domain(extentx).range([0, width]);
            // text label for the x axis
            svg.append("text")             
              .attr("transform",`translate(${width/2} , ${(height + margin.top + 30)})`)
              .style("text-anchor", "middle")
              .text("year");

            svg.append("g").attr("transform", "translate(0," + height + ")")
              .call(d3.axisBottom(x).tickFormat(d3.format("d")));
            svg.append("text")
              .attr("transform", "rotate(-90)")
              .attr("y", 0 - margin.left)
              .attr("x",0 - (height / 2))
              .attr("dy", "1em")
              .style("text-anchor", "middle")
              .text("transitor count (log)"); 

            // Add Y axis
             y = d3.scaleLog().domain(extenty).range([height, 0]);
             svg.append("g").call(d3.axisLeft(y));
        }
        function update(data) {
            // Add dots
            svg.selectAll(".dot")
                .data(data, d=>d.processor)
                .join(enter=>{
                let group = enter.append('g').attr('class', "dot")
                group.append('text')
                  .attr("class", "label")
                  .attr("font-size", "12")
                  .attr("text-anchor", "middle")//.attr("vertical-align","central")  //doesn't work
                  .attr('transform', d=>`translate(${x(d.year)},${y(d.mos)} )`)
                  .text(d=>d.processor)
                  .attr('stroke', "grey")
                  .attr("opacity", 0.75)
                  .on("mouseover", handleMouseOver)
                  .on("mouseout", handleMouseOut)
                  .transition()
                  .duration('1500')
                  .attr("opacity", 0.05)
                group.append("circle")
                  .attr("cx", d=>x(d.year))
                  .attr("cy", d=>y(d.mos))
                  .attr("r", 3)
                  .style("fill", "#69b3a2")
            }
            , update=>{
                let group = update.select("text").attr("opacity", 0)
            }
            , remove=>remove.attr("opacity", 0.75)
            .transition().duration(1000).attr("opacity", 0).remove())
        }
      // Create Event Handlers for mouse
      function handleMouseOver(d) { 
          d3.select(this).transition()
               .duration('50')
               .attr('stroke', "red")
               .attr("font-size", "18")
               .attr("opacity", 0.75)
      }
      function handleMouseOut(d) {  
          d3.select(this).transition()
               .duration('50')
               .attr('stroke', "grey")
               .attr("opacity", 0.75)
               .transition()
               .duration('1000')
               .attr("opacity", 0.05)
      }
	
        let removeChildren = (element) => {
            while (element.hasChildNodes()) {  
              element.removeChild(element.firstChild);
            }
        }

        var svg, y, x,width, height,extentx,extenty;
        /* start up ------------------------------------*/

        document.addEventListener("DOMContentLoaded", ()=>{
            const box = document.getElementById("scatter_area")
            //console.log(box.offsetWidth,box.offsetHeight)
            setup(box.offsetWidth,box.offsetHeight) 
            update(data.filter(x=> x.year< [0]))
 
            window.onresize = ()=> {
                removeChildren(box)
                setup(box.offsetWidth,box.offsetHeight) 
                update(data.filter(x=> x.year < input.value))
            }
 
            let input = document.querySelector("#recent")
            input.setAttribute("max", extentx[1])
            input.setAttribute("min", extentx[0])
            input.addEventListener('change', event=>{
                //console.log("event", input,event)
                document.getElementById("maxyear").innerHTML =  input.value
                update(data.filter(x=> x.year < input.value))
            })
            input.addEventListener('mousemove', event=>{
                //console.log("event", input,event)
                document.getElementById("maxyear").innerHTML =  input.value

                update(data.filter(x=> x.year < input.value))
            })        
            })
    </script>
</html>